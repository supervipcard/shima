{% extends "center_base.html" %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'AdminLTE-2.4.18/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block sidebar-menu %}
<ul class="sidebar-menu" data-widget="tree">
    <li class="treeview">
      <a href="#">
        <i class="fa fa-server"></i>
        <span>识别服务</span>
        <span class="pull-right-container">
          <i class="fa fa-angle-left pull-right"></i>
        </span>
      </a>
      <ul class="treeview-menu">
        {% for product_cell in products %}
            {% if product_cell.is_open %}
                <li><a href="{% url "service" pk=product_cell.id %}"><i class="fa fa-circle-o"></i> {{ product_cell.name }}</a></li>
            {% endif %}
        {% endfor %}
      </ul>
    </li>
    <li class="active treeview">
      <a href="#">
        <i class="fa fa-user"></i>
        <span>用户中心</span>
        <span class="pull-right-container">
          <span class="fa fa-angle-left pull-right"></span>
        </span>
      </a>
      <ul class="treeview-menu">
        <li><a href="{% url "account_profile" %}"><i class="fa fa-circle-o"></i> 账号管理</a></li>
        <li><a href="{% url "account_wallet" %}"><i class="fa fa-circle-o"></i> 我的钱包</a></li>
        <li class="active"><a href="{% url "account_order" %}"><i class="fa fa-circle-o"></i> 订单管理</a></li>
        <li><a href="/"><i class="fa fa-circle-o"></i> 识别记录</a></li>
      </ul>
    </li>
</ul>
{% endblock %}

{% block content %}
<section class="content">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h1 class="panel-title">我的订单</h1>
      </div>
      <div class="panel-body">
          <table id="assets_table" class="table table-bordered table-striped">

          </table>
      </div>
    </div>
</section>
{% endblock %}

{% block script %}
<script src="{% static 'AdminLTE-2.4.18/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'AdminLTE-2.4.18/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script>
$(function () {
    var transaction_type_choices = {1: '充值', 2: '新购', 3: '续费', 4: '升级'},
        pay_status_choices = {1: "待支付", 2: "已完成", 3: "超时未支付", 4: "已取消"};

    $('#assets_table').DataTable({
      "serverSide": true,
      "paging": true,       <!-- 允许分页 -->
      "pagingType": "full_numbers",
      "lengthChange": false, <!-- 允许改变每页显示的行数 -->
      "searching": false,    <!-- 允许内容搜索 -->
      "ordering": false,     <!-- 允许排序 -->
      "info": false,         <!-- 显示信息 -->
      "autoWidth": false,    <!-- 固定宽度 -->
      "language": {"emptyTable": "暂无订单", "paginate": {"first": "«", "last": "»", "previous": "上一页", "next": "下一页"}},
      "ajax": function (data, callback, settings) {
        var page = (data.start) / data.length + 1;
        $.ajax({
          "url": "{% url "order_list" %}",
          "data": {"page": page},
          "success": function (result) {
              var returnData = {};
              returnData.recordsTotal = result.count; //返回数据全部记录
              returnData.recordsFiltered = result.count; //后台不实现过滤功能，每次查询均视作全部结果
              returnData.data = result.results; //返回的数据列表
              callback(returnData);
          }
        })
      },
      //"ajax": {
      //    "url": "{% url "order_list" %}",
      //    "dataSrc": "results",
      //},
      "columns": [
            {
                "title" : "订单编号",
                "data": "order_id",
            },
            {
                "title" : "交易类型",
                "data": "transaction_type",
                "render": function (data, type, row) {
                    return transaction_type_choices[data]
                }
            },
            {
                "title" : "下单时间",
                "data": "add_time",
            },
            {
                "title" : "总金额",
                "data": "amount",
                "render": function (data, type, row) {
                    return data.toFixed(2)
                }
            },
            {
                "title" : "订单状态",
                "data": "pay_status",
                "render": function (data, type, row) {
                    return pay_status_choices[data]
                }
            },
            {
                "title" : "操作",
                "render": function (data, type, row) {
                    if (row["pay_status"] === 1){
                        return '<a class="btn btn-primary btn-xs" href="' + '/order/details/' + row['order_id'] + '" role="button">支付</button>'
                    }
                    else {
                        return '<a class="btn btn-default btn-xs" href="' + '/order/details/' + row['order_id'] + '" role="button">详情</button>'
                    }
                },
                "class" : "text-center",
            },
        ]
    });
});
</script>
{% endblock %}
