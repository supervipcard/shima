{% extends "center_base.html" %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'AdminLTE-2.4.18/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block sidebar-menu %}
<ul class="sidebar-menu" data-widget="tree">
    <li class="active treeview">
      <a href="#">
        <i class="fa fa-server"></i>
        <span>识别服务</span>
        <span class="pull-right-container">
          <i class="fa fa-angle-left pull-right"></i>
        </span>
      </a>
      <ul class="treeview-menu">
        {% for product_cell in products %}
            {% if product_cell.is_open %}
                {% if product == product_cell %}
                    <li class="active"><a href="{% url "service" pk=product_cell.id %}"><i class="fa fa-circle-o"></i> {{ product_cell.name }}</a></li>
                {% else %}
                    <li><a href="{% url "service" pk=product_cell.id %}"><i class="fa fa-circle-o"></i> {{ product_cell.name }}</a></li>
                {% endif %}
            {% endif %}
        {% endfor %}
      </ul>
    </li>
    <li class="treeview">
      <a href="#">
        <i class="fa fa-user"></i>
        <span>用户中心</span>
        <span class="pull-right-container">
          <span class="fa fa-angle-left pull-right"></span>
        </span>
      </a>
      <ul class="treeview-menu">
        <li><a href="{% url "account_profile" %}"><i class="fa fa-circle-o"></i> 账号管理</a></li>
        <li><a href="{% url "account_wallet" %}"><i class="fa fa-circle-o"></i> 我的钱包</a></li>
        <li><a href="{% url "account_order" %}"><i class="fa fa-circle-o"></i> 订单管理</a></li>
        <li><a href=""><i class="fa fa-circle-o"></i> 识别记录</a></li>
      </ul>
    </li>
</ul>
{% endblock %}

{% block content %}
<section class="content">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h1 class="panel-title">{{ product.name }}</h1>
      </div>
      <div class="panel-body">
          <div class="group-info">
              <h3>欢迎使用{{ product.name }}服务，使用前请仔细阅读
              <a href="{{ product.doc_url }}" target="_blank">接入文档</a>
              </h3>
          </div>
          <table id="assets_table" class="table table-bordered table-striped">

          </table>
          <button class="btn btn-info" data-toggle="modal" data-target="#myModal"><i class="fa fa-plus"></i> 选购通道</button>
          <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">选购{{ product.name }}通道</h4>
                  </div>
                  <form id="buy-form" method="post">
                      {% csrf_token %}
                      <div class="modal-body">
                          <div class="group-info">
                              <h4>基础套餐默认每秒 5 个请求数，若有额外需求，可增加额外每秒请求数。</h4>
                          </div>
                          <div class="form-group">
                            <label for="package">套餐</label>
                            <select class="form-control" id="package" required oninput="calculate()">
                                {% for cell in product_package %}
                                    <option value="{{ cell.id }}">{{ cell }}</option>
                                {% endfor %}
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="additional_concurrency">额外每秒请求数</label>
                            <input type="number" class="form-control" id="additional_concurrency" autocomplete="off" min="0" max="100" maxlength="4" value="0" required oninput="calculate()">
                          </div>
                          <div class="form-group">
                            <label for="period">购买周期</label>
                            <input type="number" class="form-control" id="period" autocomplete="off" min="1" max="24" maxlength="2" value="1" required oninput="calculate()">
                          </div>
                          <div class="form-group">
                            <label for="num">通道数</label>
                            <input type="number" class="form-control" id="num" autocomplete="off" min="1" max="1000" maxlength="4" value="1" required oninput="calculate()">
                          </div>
                          <div class="total_money">
                              <span>总金额：</span>
                              <span class="text_money"><i class="fa fa-cny"></i> <span id="money">1.0</span></span>
                          </div>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                          <button type="submit" class="btn btn-primary">购买</button>
                      </div>
                  </form>
                </div>
            </div>
        </div>

      </div>
    </div>
</section>
{% endblock %}

{% block script %}
<script src="{% static 'AdminLTE-2.4.18/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'AdminLTE-2.4.18/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script>
function calculate(){
    var package_text = $('#package option:selected').text(),
        additional_concurrency = Number($('#additional_concurrency').val()),
        period = Number($('#period').val()),
        num = Number($('#num').val());
    var price = /基础（(.*?)元/.exec(package_text)[1].trim();
    var additional_concurrency_price = /额外每秒请求数（(.*?)元/.exec(package_text)[1].trim();
    var total_money = (Number(price) + Number(additional_concurrency_price) * additional_concurrency) * period * num;
    $('#money').text(total_money.toFixed(1));
}
</script>
<script>
$(function () {
    $('#assets_table').DataTable({
      "paging": true,       <!-- 允许分页 -->
      "pagingType": "full_numbers",
      "lengthChange": false, <!-- 允许改变每页显示的行数 -->
      "searching": false,    <!-- 允许内容搜索 -->
      "ordering": false,     <!-- 允许排序 -->
      "info": false,         <!-- 显示信息 -->
      "autoWidth": false,    <!-- 固定宽度 -->
      "language": {"emptyTable": "暂无通道", "paginate": {"first": "«", "last": "»", "previous": "上一页", "next": "下一页"}},
      "ajax": {
          "url": "{% url "channel_list" %}?product={{ product.id }}",
          "dataSrc": "results",
      },
      "columns": [
            {
                "title" : "通道ID",
                "data": "id",
            },
            {
                "title" : "通行秘钥",
                "data": "access_token",
            },
            {
                "title" : "每秒请求数",
                "data": "concurrency",
            },
            {
                "title" : "创建时间",
                "data": "creation_time",
            },
            {
                "title" : "续费时间",
                "data": "renewal_time",
                "render": function (data, type, row) {
                    if (data){
                        return data
                    }
                    else{
                        return '-'
                    }
                }
            },
            {
                "title" : "到期时间",
                "data": "expiration_time",
            },
            {
                "title" : "操作",
                "render": function (data, type, row) {
                    return '<button class="btn btn-primary btn-xs" type="button">续费</button><button class="btn btn-primary btn-xs" style="margin-left: 10px" type="button">升级</button>'
                },
                "class" : "text-center",
            },
        ]
    });
});
</script>
<script>
$('#buy-form').submit(function () {
    var product_package_id = $('#package').val(),
        additional_concurrency = $('#additional_concurrency').val(),
        period = $('#period').val(),
        num = $('#num').val();
    var data = {product_package_id: product_package_id, additional_concurrency: additional_concurrency, period: period, number: num};
    $.ajax({
        url: "{% url "order_place" %}",
        type: "POST",
        data: JSON.stringify(data),
        dataType: "json",
        contentType:"application/json;charset=utf-8",
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", $('[name="csrfmiddlewaretoken"]').val());
        },
        success: function (result) {
            if (result['code'] === 0) {
                window.location.href = result['data']['order_url'];
            }
            else {
                alert("服务器异常");
            }
        },
        error: function () {
            alert("服务器异常");
        }
    });
    return false
});
</script>
{% endblock %}
